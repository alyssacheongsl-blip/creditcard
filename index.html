<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡ç”¨å¡åˆ†æœŸè¿½è¹¤ PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e40af', // è—è‰²
                        'primary-light': '#3b82f6', // æ·ºè—
                        'bg-dark': '#111827', // å¹¾ä¹é»‘è‰²
                        'bg-light': '#f3f4f6', // å¹¾ä¹ç™½è‰²
                        'card-dark': '#1f2937', // æ·±ç°
                        'card-light': '#ffffff', // ç™½è‰²
                    }
                }
            }
        }
    </script>

    <style>
        /* éš±è— Chrome/Safari çš„æ»¾å‹•æ¢ */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç¢ºä¿ PWA çš„å…¨è¢å¹•é«”é©— */
        .app-container { min-height: 100vh; }
        
        /* ğŸ’¡ ä¿®æ­£ 1: å¼·åŒ–è¼¸å…¥æ¡†å’Œæ¨™ç±¤çš„å¤œé–“æ¨¡å¼æ¨£å¼ */
        input[type="text"], input[type="number"], select, input[type="month"], input[type="date"] {
            /* æ·ºè‰²æ¨¡å¼: ç™½è‰²èƒŒæ™¯, é»‘è‰²æ–‡å­— */
            /* æ·±è‰²æ¨¡å¼: å¡ç‰‡æ·±ç°èƒŒæ™¯, æ·ºé’è‰²æ–‡å­— */
            @apply bg-card-light dark:bg-card-dark border border-gray-300 dark:border-gray-700 text-gray-900 
                   dark:text-cyan-300; /* ğŸ’¡ å¼·åŒ–ï¼šå¤œé–“æ¨¡å¼æ”¹ç”¨æ·ºé’è‰²æ–‡å­— (ä¿®æ­£è¼¸å…¥æ¡†å…§æ–‡å­—ä¸æ˜é¡¯) */
        }
        
        /* å¼·åŒ–æ¨™ç±¤æ–‡å­—é¡è‰² (ç¢ºä¿æ¨™ç±¤åœ¨æ·±è‰²æ¨¡å¼ä¸‹çªå‡º) */
        label {
             @apply dark:text-gray-200; /* è®“æ¨™ç±¤æ–‡å­—åœ¨æ·±è‰²èƒŒæ™¯ä¸‹æ›´äº® */
        }
        
        /* PWA æé†’æ’ç¨‹çš„å‹•ç•« */
        @keyframes pulse-ring {
            0% { transform: scale(.3); opacity: 0; }
            50% { opacity: .7; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .reminder-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            z-index: 0;
        }
        
        /* ç¢ºä¿æ´»å‹• Tab æ¨£å¼æ­£ç¢º */
        .active-tab {
            @apply bg-primary-dark dark:bg-primary-light text-white;
        }
    </style>
</head>

<body class="bg-bg-light dark:bg-bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="app" class="app-container max-w-xl mx-auto p-4 sm:p-6 pb-20">

        <header class="flex justify-between items-center mb-6 pt-2">
            <h1 class="text-3xl font-bold text-primary-dark dark:text-primary-light">ğŸ’³ åˆ†æœŸè¿½è¹¤</h1>
            <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <svg id="themeIcon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>
        
        <div class="flex space-x-2 mb-4 p-1 bg-gray-200 dark:bg-gray-800 rounded-lg">
            <button id="tab-dashboard" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700">å„€è¡¨æ¿</button>
            <button id="tab-credit-cards" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700">ä¿¡ç”¨å¡ç®¡ç†</button>
            <button id="tab-archive" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700">æ­¸æª”</button>
        </div>
        
        <div id="dashboard-view" class="tab-content hidden">
            
            <section class="mb-6 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-3 border-b pb-2 border-gray-200 dark:border-gray-700">ğŸ“Š æœ¬æœˆæ¦‚æ³</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-red-600 dark:text-yellow-400" id="totalMonthlyPayment">N/A</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ç•¶æœˆç¸½ç¹³æ¬¾é¡</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600 dark:text-cyan-400" id="nextEstimatedDate">N/A</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ä¸‹æœŸé ä¼°æ‰£æ¬¾æ—¥</p>
                    </div>
                </div>
            </section>
            
            <div class="mb-4 flex space-x-2">
                <input type="text" id="filterText" placeholder="æœå°‹é …ç›®æˆ–å¡ç‰‡..." class="flex-grow p-2 rounded-lg" oninput="displayInstallments()">
                <select id="filterCard" class="p-2 rounded-lg" onchange="displayInstallments()">
                    <option value="">æ‰€æœ‰å¡ç‰‡</option>
                </select>
            </div>
            
            <div id="reminderContainer" class="p-3 mb-4 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 rounded-lg hidden">
                <p id="reminderMessage" class="font-medium"></p>
            </div>
            
            <section>
                <h2 class="text-xl font-semibold mb-3">å¾…ç¹³åˆ†æœŸ</h2>
                <div id="installmentsList" class="space-y-4">
                    <p id="noInstallments" class="text-center text-gray-500 dark:text-gray-400">ç›®å‰æ²’æœ‰å¾…ç¹³åˆ†æœŸã€‚</p>
                </div>
            </section>
            
            <button id="openNewInstallmentModal" class="fixed bottom-4 right-4 z-10 w-14 h-14 bg-primary-dark dark:bg-primary-light text-white rounded-full shadow-xl flex items-center justify-center text-3xl font-light hover:scale-105 transition-transform duration-200" title="æ–°å¢æ¶ˆè²»">+</button>

        </div>
        
        <div id="credit-cards-view" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ’³ ä¿¡ç”¨å¡ç®¡ç†</h2>
            <p id="noCards" class="text-center text-gray-500 dark:text-gray-400 space-y-3 mb-6">ç›®å‰æ²’æœ‰æ–°å¢å¡ç‰‡ã€‚</p>
            <div id="creditCardsList" class="space-y-3 mb-6">
                </div>
            <button id="openNewCardModal" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow transition">æ–°å¢ä¿¡ç”¨å¡</button>
        </div>

        <div id="archive-view" class="tab-content hidden">
             <h2 class="text-2xl font-bold mb-4">ğŸ—„ï¸ å·²ç¹³æ¸…æ­¸æª”</h2>
             <div id="archiveList" class="space-y-4">
                 <p id="noArchive" class="text-center text-gray-500 dark:text-gray-400">æ­¸æª”å€ç›®å‰æ˜¯ç©ºçš„ã€‚</p>
             </div>
        </div>

    </div>
    
    <div id="installmentModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4 z-20 hidden">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">æ–°å¢æ¶ˆè²»åˆ†æœŸ</h3>
            
            <div id="installmentError" class="hidden p-3 mb-4 text-sm bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg">
                </div>
            
            <form id="installmentForm" class="space-y-4">
                <input type="hidden" id="installmentId">
                <div>
                    <label for="item" class="block text-sm font-medium mb-1">æ¶ˆè²»é …ç›®</label>
                    <input type="text" id="item" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="cardId" class="block text-sm font-medium mb-1">é¸æ“‡ä¿¡ç”¨å¡</label>
                    <select id="cardId" required class="w-full p-2 border rounded-lg">
                        </select>
                </div>
                
                <div>
                    <label for="transactionDate" class="block text-sm font-medium mb-1">æ¶ˆè²»æ—¥ (äº¤æ˜“æ—¥)</label>
                    <input type="date" id="transactionDate" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="postingDate" class="block text-sm font-medium mb-1">å…¥å¸³æ—¥ (å…¥å¸³èµ·æ¯æ—¥)</label>
                    <input type="date" id="postingDate" required class="w-full p-2 border rounded-lg">
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium mb-1">ç¸½é‡‘é¡</label>
                    <input type="number" id="amount" required min="1" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="totalPeriods" class="block text-sm font-medium mb-1">åˆ†æœŸæœŸæ•¸ (æœˆ)</label>
                    <input type="number" id="totalPeriods" required min="1" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="firstPaymentMonth" class="block text-sm font-medium mb-1">é¦–æœŸç¹³æ¬¾æœˆä»½</label>
                    <input type="month" id="firstPaymentMonth" required class="w-full p-2 border rounded-lg">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeModal('installmentModal')" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-primary-dark dark:bg-primary-light text-white rounded-lg hover:opacity-90 transition">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4 z-20 hidden">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4">æ–°å¢/ç·¨è¼¯ä¿¡ç”¨å¡</h3>
            <form id="cardForm" class="space-y-4">
                <input type="hidden" id="cardFormId">
                <div>
                    <label for="cardName" class="block text-sm font-medium mb-1">éŠ€è¡Œ/å¡ç‰‡åç¨±</label>
                    <input type="text" id="cardName" required class="w-full p-2 border rounded-lg">
                </div>
                
                <div>
                    <label for="cardCurrency" class="block text-sm font-medium mb-1">å¹£åˆ¥é¸æ“‡</label>
                    <select id="cardCurrency" required class="w-full p-2 border rounded-lg">
                        <option value="NT$">æ–°å°å¹£ (NT$)</option>
                        <option value="Â¥">äººæ°‘å¹£/æ—¥åœ“ (Â¥)</option>
                        <option value="$">ç¾å…ƒ ($)</option>
                    </select>
                </div>

                <div>
                    <label for="cardLimit" class="block text-sm font-medium mb-1">ä¿¡ç”¨é¡åº¦</label>
                    <input type="number" id="cardLimit" required min="0" class="w-full p-2 border rounded-lg">
                </div>
                
                <div>
                    <label for="cardBillingDate" class="block text-sm font-medium mb-1">å¸³å–®çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
                    <input type="number" id="cardBillingDate" required min="1" max="31" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="cardDueDate" class="block text-sm font-medium mb-1">ç¹³è²»æˆªæ­¢æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
                    <input type="number" id="cardDueDate" required min="1" max="31" class="w-full p-2 border rounded-lg">
                </div>

                <div>
                    <label for="cardAnnualFee" class="block text-sm font-medium mb-1">å¹´è²»</label>
                    <input type="number" id="cardAnnualFee" value="0" min="0" class="w-full p-2 border rounded-lg">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeModal('cardModal')" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-primary-dark dark:bg-primary-light text-white rounded-lg hover:opacity-90 transition">å„²å­˜å¡ç‰‡</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const STORAGE_KEY_INSTALLMENTS = 'pwa_installments_v2';
        const STORAGE_KEY_CARDS = 'pwa_credit_cards_v3'; // V3: å¢åŠ  currency
        const STORAGE_KEY_ARCHIVE = 'pwa_archive_v2';
        const STORAGE_KEY_THEME = 'pwa_theme';

        let installments = [];
        let cards = [];
        let archive = [];
        
        // --- é€šç”¨å·¥å…·å‡½æ•¸ ---

        /**
         * è®€å– localStorage æ•¸æ“š
         */
        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                const parsedData = data ? JSON.parse(data) : [];
                return parsedData;
            } catch (error) {
                console.error(`Error loading data for key: ${key}`, error);
                return [];
            }
        }

        /**
         * å„²å­˜æ•¸æ“šåˆ° localStorage (å¼·åŒ–éŒ¯èª¤æç¤º)
         */
        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`FATAL ERROR: Failed to save data for key: ${key}. Error:`, error);
                alert(`å„²å­˜æ•¸æ“šå¤±æ•—ï¼å¯èƒ½æ˜¯æ‚¨çš„è£ç½®å„²å­˜ç©ºé–“å·²æ»¿æˆ–ç€è¦½å™¨éš±ç§è¨­å®šé˜»æ­¢äº†å„²å­˜ã€‚éŒ¯èª¤è©³æƒ…: ${error.message}`);
            }
        }

        /**
         * æ ¼å¼åŒ–é‡‘é¡ç‚ºè²¨å¹£å­—ä¸² (ä½¿ç”¨å‚³å…¥çš„å¹£åˆ¥ç¬¦è™Ÿ)
         * ç¢ºä¿é‡‘é¡ç‚ºæœ‰æ•ˆæ•¸å­—ï¼Œå¦å‰‡é¡¯ç¤º 0
         */
        function formatCurrency(amount, currencySymbol = 'NT$') {
            const safeAmount = parseFloat(amount) || 0;
            return `${currencySymbol}${safeAmount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        }
        
        /**
         * æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM
         */
        function formatMonth(date) {
            return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        }
        
        /**
         * æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
         */
        function formatDate(date) {
             const d = new Date(date);
             const dMonth = d.getMonth() + 1;
             const dDay = d.getDate();

             return d.getFullYear() + '-' + String(dMonth).padStart(2, '0') + '-' + String(dDay).padStart(2, '0');
        }


        /**
         * ç²å–ä¸‹ä¸€å€‹ç¹³æ¬¾æœˆä»½çš„ Date å°è±¡ (ä½¿ç”¨å›ºå®šçš„ 15 è™Ÿä½œç‚ºé ä¼°æ—¥)
         */
        function getNextPaymentDate(firstPaymentMonth, paidPeriods) {
            // æ ¸å¿ƒé©—è­‰ï¼šé˜²æ­¢ firstPaymentMonth ç‚º null æˆ–æ ¼å¼éŒ¯èª¤
            if (!firstPaymentMonth || typeof firstPaymentMonth !== 'string' || !firstPaymentMonth.includes('-')) {
                throw new Error("firstPaymentMonth æ ¼å¼ä¸æ­£ç¢ºã€‚");
            }

            const parts = firstPaymentMonth.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10); // 1-12

            if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                 throw new Error("firstPaymentMonth å¹´ä»½æˆ–æœˆä»½ç„¡æ•ˆã€‚");
            }
            if (isNaN(paidPeriods) || paidPeriods < 0) {
                 throw new Error("paidPeriods æœŸæ•¸ç„¡æ•ˆã€‚");
            }
            
            // JavaScript çš„ Date æœˆä»½å¾ 0 é–‹å§‹ (æ‰€ä»¥è¦ -1)
            // åŠ ä¸Š paidPeriods å¾—åˆ°ä¸‹ä¸€æ¬¡ç¹³æ¬¾æœˆä»½çš„ Date å°è±¡
            const nextDate = new Date(year, month - 1 + paidPeriods, 15);
            
            // å†æ¬¡é©—è­‰æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            if (isNaN(nextDate.getTime())) {
                 throw new Error("è¨ˆç®—å‡ºçš„æ—¥æœŸç„¡æ•ˆã€‚");
            }
            
            return nextDate; // è¿”å›ä¸‹ä¸€æ¬¡çµå¸³çš„æ—¥æœŸ
        }
        
        /**
         * é—œé–‰ä»»ä¸€æ¨¡æ…‹æ¡†
         */
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨é‚è¼¯ ---

        function initializeApp() {
            try {
                // è¼‰å…¥æ•¸æ“š
                installments = loadData(STORAGE_KEY_INSTALLMENTS);
                cards = loadData(STORAGE_KEY_CARDS);
                archive = loadData(STORAGE_KEY_ARCHIVE);
                
                // æ•¸æ“šé·ç§»/ä¿®å¾©ï¼šç¢ºä¿æ‰€æœ‰æ•¸æ“šçµæ§‹å®Œæ•´
                cards = cards.map(card => ({
                    ...card,
                    cardCurrency: card.cardCurrency || 'NT$' 
                }));
                
                installments = installments.map(item => ({
                    ...item,
                    monthlyPayment: parseFloat(item.monthlyPayment) || 0,
                    remainingAmount: parseFloat(item.remainingAmount) || 0,
                    // ç¢ºä¿ transactionDate å’Œ postingDate æœ‰é è¨­å€¼ (å¦‚æœè³‡æ–™åº«ä¸­æ²’æœ‰)
                    transactionDate: item.transactionDate || '',
                    postingDate: item.postingDate || '',
                }));
                
                // å„²å­˜ä¸€æ¬¡ï¼Œç¢ºä¿æ‰€æœ‰å¡ç‰‡éƒ½æœ‰å¹£åˆ¥è³‡è¨Š
                saveData(STORAGE_KEY_CARDS, cards);
                saveData(STORAGE_KEY_INSTALLMENTS, installments); 
                
                setupEventHandlers();
                loadTheme();
                
                // å¿…é ˆå…ˆè¼‰å…¥å¡ç‰‡ï¼Œå› ç‚ºåˆ†æœŸéœ€è¦å¡ç‰‡è³‡è¨Š
                displayCreditCards();
                populateCardSelects();
                
                // æ›´æ–°çµ±è¨ˆå’Œåˆ†æœŸåˆ—è¡¨
                updateDashboardStats();
                displayInstallments(); 
                displayArchive();
                
                // é è¨­åˆ‡æ›åˆ°å„€è¡¨æ¿ï¼Œç¢ºä¿ UI ç‹€æ…‹æ­£ç¢º
                switchTab('dashboard'); 

            } catch (e) {
                console.error("initializeApp ç™¼ç”Ÿè‡´å‘½éŒ¯èª¤:", e);
                alert("æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯ã€‚");
            }
        }
        
        function setupEventHandlers() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            document.getElementById('tab-dashboard').addEventListener('click', () => switchTab('dashboard'));
            document.getElementById('tab-credit-cards').addEventListener('click', () => switchTab('credit-cards'));
            document.getElementById('tab-archive').addEventListener('click', () => switchTab('archive'));

            document.getElementById('openNewInstallmentModal').addEventListener('click', () => openInstallmentModal());
            document.getElementById('installmentForm').addEventListener('submit', handleInstallmentSubmit);
            
            document.getElementById('openNewCardModal').addEventListener('click', () => openCardModal());
            document.getElementById('cardForm').addEventListener('submit', handleCardSubmit);
            
            if ('serviceWorker' in navigator) {
                 navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered successfully. Scope: ' + reg.scope))
                    .catch(err => console.error('Service Worker registration failed:', err));
            }
        }
        
        // --- ä¸»é¡Œåˆ‡æ› (æ·ºè‰²/æ·±è‰²æ¨¡å¼) ---

        function loadTheme() {
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            
            if (theme === 'dark') {
                html.classList.add('dark');
                // æ›¿æ›ç‚ºå¤ªé™½åœ–ç¤º
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707M12 6v6l2 2m-2-4l-2 2"></path>';
            } else {
                html.classList.remove('dark');
                // æ›¿æ›ç‚ºæœˆäº®åœ–ç¤º
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
            localStorage.setItem(STORAGE_KEY_THEME, theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        }

        // --- Tab å°èˆª ---

        function switchTab(tabName) {
            ['dashboard', 'credit-cards', 'archive'].forEach(name => {
                const view = document.getElementById(`${name}-view`); 
                const tabButton = document.getElementById(`tab-${name}`); 
                
                if (view && tabButton) { 
                    view.classList.add('hidden');
                    tabButton.classList.remove('active-tab', 'bg-primary-dark', 'dark:bg-primary-light', 'text-white');
                    tabButton.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-700');
                }
            });
            
            const activeView = document.getElementById(`${tabName}-view`); 
            const activeTabButton = document.getElementById(`tab-${tabName}`); 
            
            if (activeView && activeTabButton) { 
                activeView.classList.remove('hidden');
                activeTabButton.classList.add('active-tab', 'bg-primary-dark', 'dark:bg-primary-light', 'text-white');
                activeTabButton.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-700');
            }
        }

        // --- ä¿¡ç”¨å¡ç®¡ç† --- 
        
        /**
         * è™•ç†æ–°å¢/ç·¨è¼¯ä¿¡ç”¨å¡è¡¨å–®æäº¤
         */
        function handleCardSubmit(e) {
            e.preventDefault();
            try {
                const id = document.getElementById('cardFormId').value || `card-${Date.now()}`;
                const name = document.getElementById('cardName').value.trim();
                const cardCurrency = document.getElementById('cardCurrency').value;
                const limit = parseFloat(document.getElementById('cardLimit').value.trim()) || 0;
                const annualFee = parseFloat(document.getElementById('cardAnnualFee').value.trim()) || 0;
                const billingDate = parseInt(document.getElementById('cardBillingDate').value.trim());
                const dueDate = parseInt(document.getElementById('cardDueDate').value.trim());

                if (!name || isNaN(limit) || limit <= 0 || isNaN(billingDate) || billingDate < 1 || billingDate > 31 || isNaN(dueDate) || dueDate < 1 || dueDate > 31) {
                    alert('éŒ¯èª¤ï¼šè«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦å¡«å¯«å®Œæ•´ä¸”æ•¸å€¼æœ‰æ•ˆã€‚');
                    return;
                }

                const existingIndex = cards.findIndex(c => c.id === id);
                const cardData = { id, name, cardCurrency, limit, annualFee, billingDate, dueDate };

                if (existingIndex > -1) {
                    cards[existingIndex] = { ...cards[existingIndex], ...cardData };
                } else {
                    cards.push(cardData);
                }

                cards.sort((a, b) => b.limit - a.limit);
                saveData(STORAGE_KEY_CARDS, cards);
                displayCreditCards();
                populateCardSelects();
                updateDashboardStats();
                closeModal('cardModal');

            } catch (error) {
                console.error('handleCardSubmit ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('å¡ç‰‡è™•ç†å¤±æ•—ï¼è«‹æª¢æŸ¥è¼¸å…¥å€¼ã€‚éŒ¯èª¤è©³æƒ…: ' + error.message);
            }
        }
        
        /**
         * æ¸²æŸ“ä¿¡ç”¨å¡åˆ—è¡¨
         */
        function displayCreditCards() {
            const list = document.getElementById('creditCardsList');
            list.innerHTML = '';
            document.getElementById('noCards').classList.toggle('hidden', cards.length > 0);

            cards.forEach(card => {
                try {
                    const currencySymbol = card.cardCurrency || 'NT$';
                    
                    // è¨ˆç®—ç¸½åˆ†æœŸå‰©é¤˜é‡‘é¡
                    const totalRemaining = installments
                        .filter(i => i.cardId === card.id)
                        .reduce((sum, i) => sum + (parseFloat(i.remainingAmount) || 0), 0);
                    
                    const availableLimit = card.limit - totalRemaining;
                    const percentage = card.limit > 0 ? ((totalRemaining / card.limit) * 100).toFixed(1) : 0;

                    const costDisplay = `çµå¸³æ—¥: ${card.billingDate || 'N/A'} è™Ÿ`;
                    const dateDisplay = `ç¹³è²»æ—¥: ${card.dueDate || 'N/A'} è™Ÿ`;

                    list.innerHTML += `
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-semibold">${card.name} <span class="text-sm font-light text-gray-500 dark:text-gray-400">(${currencySymbol})</span> </h4>
                                <div class="space-x-2">
                                    <button onclick="openCardModal(cards.find(c => c.id === '${card.id}'))" class="text-sm text-primary-dark dark:text-primary-light hover:underline">ç·¨è¼¯é¡åº¦</button>
                                    <button onclick="deleteCard('${card.id}')" class="text-sm text-red-500 hover:underline">åˆªé™¤</button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${costDisplay}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2 font-medium">${dateDisplay}</p>
                            <div class="text-sm">
                                <p>ç¸½é¡åº¦: <span class="font-medium">${formatCurrency(card.limit, currencySymbol)}</span></p>
                                <p>å‰©é¤˜é¡åº¦: <span class="font-medium ${availableLimit < 0 ? 'text-red-500' : 'text-green-500'}">${formatCurrency(availableLimit, currencySymbol)}</span></p>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2">
                                <div class="h-2.5 rounded-full ${percentage > 75 ? 'bg-red-500' : percentage > 50 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${percentage}%"></div>
                            </div>
                            <p class="text-xs text-right mt-1 text-gray-500 dark:text-gray-400">${percentage}% å·²ä½¿ç”¨</p>
                        </div>
                    `;
                } catch (e) {
                    console.error(`æ¸²æŸ“å¡ç‰‡ ${card.id} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, e);
                    list.innerHTML += `<p class="p-4 bg-red-100 dark:bg-red-900/50 text-red-600 rounded-lg">âŒ å¡ç‰‡ [${card.name}] æ•¸æ“šæå£ï¼Œè«‹åˆªé™¤å¾Œé‡æ–°æ–°å¢ã€‚</p>`;
                }
            });
        }

        /**
         * è™•ç†åˆªé™¤å¡ç‰‡
         */
        function deleteCard(id) {
             if (confirm("ç¢ºèªè¦åˆªé™¤é€™å¼µä¿¡ç”¨å¡å—ï¼Ÿæ‰€æœ‰ç›¸é—œåˆ†æœŸé …ç›®å°‡æœƒä¸€ä½µç§»é™¤ï¼")) {
                 cards = cards.filter(c => c.id !== id);
                 // åŒæ™‚åˆªé™¤æ‰€æœ‰ç›¸é—œåˆ†æœŸ
                 installments = installments.filter(i => i.cardId !== id); 
                 saveData(STORAGE_KEY_CARDS, cards);
                 saveData(STORAGE_KEY_INSTALLMENTS, installments);
                 displayCreditCards();
                 populateCardSelects();
                 updateDashboardStats();
                 displayInstallments(); // åˆ·æ–°å„€è¡¨æ¿
             }
        }

        /**
         * æ‰“é–‹ä¿¡ç”¨å¡æ¨¡æ…‹æ¡†
         */
        function openCardModal(card = null) {
            document.getElementById('cardFormId').value = card ? card.id : '';
            document.getElementById('cardName').value = card ? card.name : '';
            document.getElementById('cardCurrency').value = card && card.cardCurrency ? card.cardCurrency : 'NT$';
            document.getElementById('cardLimit').value = card ? card.limit : 0;
            document.getElementById('cardAnnualFee').value = card ? card.annualFee : 0;
            document.getElementById('cardBillingDate').value = card ? card.billingDate : '';
            document.getElementById('cardDueDate').value = card ? card.dueDate : '';
            document.getElementById('cardModal').classList.remove('hidden');
        }

        /**
         * å¡«å……ä¿¡ç”¨å¡ä¸‹æ‹‰é¸å–® (æ–°å¢æ¶ˆè²»å’Œéæ¿¾)
         */
        function populateCardSelects() {
            const selects = [document.getElementById('cardId'), document.getElementById('filterCard')];
            const hasFilterSelect = selects.some(s => s && s.id === 'filterCard');
            
            selects.forEach(select => {
                if (!select) return;
                
                // æ¸…ç©ºé™¤äº†ã€Œæ‰€æœ‰å¡ç‰‡ã€ä¹‹å¤–çš„é¸é …
                const initialOptionsCount = select.id === 'filterCard' ? 1 : 0;
                while (select.options.length > initialOptionsCount) {
                    select.remove(initialOptionsCount);
                }

                cards.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.id;
                    option.textContent = `${card.name} (${card.cardCurrency || 'NT$'}é¡åº¦: ${formatCurrency(card.limit, '')})`;
                    select.appendChild(option);
                });
            });
        }


        // --- åˆ†æœŸé …ç›®ç®¡ç† ---

        /**
         * è™•ç†æ–°å¢/ç·¨è¼¯åˆ†æœŸè¡¨å–®æäº¤
         */
        function handleInstallmentSubmit(e) {
            e.preventDefault();
            
            // ğŸ’¡ ç²å–éŒ¯èª¤é¡¯ç¤ºå…ƒç´ ä¸¦å…ˆéš±è—
            const errorDisplay = document.getElementById('installmentError');
            errorDisplay.classList.add('hidden');

            const id = document.getElementById('installmentId').value || `inst-${Date.now()}`;
            const item = document.getElementById('item').value.trim();
            const cardId = document.getElementById('cardId').value;
            const transactionDate = document.getElementById('transactionDate').value;
            const postingDate = document.getElementById('postingDate').value;
            
            // ç¢ºä¿æ•¸å€¼è½‰æ›å’Œæ¬„ä½å¡«å¯«
            const amount = parseFloat(document.getElementById('amount').value.trim()); 
            const totalPeriods = parseInt(document.getElementById('totalPeriods').value.trim()); 
            const firstPaymentMonth = document.getElementById('firstPaymentMonth').value; 
            
            // âš ï¸ å¿…å¡«æ¬„ä½æª¢æŸ¥
            if (!item || !cardId || isNaN(amount) || amount <= 0 || isNaN(totalPeriods) || totalPeriods <= 0 || !firstPaymentMonth) {
                // ğŸš¨ é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯åœ¨æ¨¡æ…‹æ¡†å…§
                errorDisplay.textContent = 'âŒ è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦å¡«å¯«å®Œæ•´ä¸”æ•¸å€¼æœ‰æ•ˆï¼ç‰¹åˆ¥æ˜¯ã€Œé¦–æœŸç¹³æ¬¾æœˆä»½ã€';
                errorDisplay.classList.remove('hidden');
                return; // é©—è­‰å¤±æ•—ï¼Œç›´æ¥è·³å‡º
            }
            
            // è¨ˆç®—å–®æœŸæ‡‰ç¹³é‡‘é¡ (åƒ…åœ¨æ–°å¢æ™‚è¨ˆç®—)
            const monthlyPayment = (amount / totalPeriods).toFixed(2); // ç²¾ç¢ºåˆ°å°æ•¸é»å…©ä½

            // æ‰¾å‡ºç¾æœ‰é …ç›®ç´¢å¼•
            const existingIndex = installments.findIndex(i => i.id === id);
            
            // ç·¨è¼¯ç‹€æ…‹ä¸‹ï¼Œé€™äº›å€¼ä¸æ‡‰æ”¹è®Šï¼Œåƒ…åœ¨æ–°å¢æ™‚è¨­å®šåˆå§‹å€¼
            let paidPeriods = existingIndex > -1 ? installments[existingIndex].paidPeriods : 0;
            let remainingPeriods = existingIndex > -1 ? installments[existingIndex].remainingPeriods : totalPeriods;
            let remainingAmount = existingIndex > -1 ? installments[existingIndex].remainingAmount : amount;

            // æ§‹å»ºæ•¸æ“šç‰©ä»¶
            let installmentData = {
                id, 
                item, 
                cardId, 
                transactionDate, 
                postingDate,
                totalAmount: amount, 
                totalPeriods, 
                firstPaymentMonth, 
                monthlyPayment: parseFloat(monthlyPayment), // å„²å­˜ç‚ºæ•¸å­—
                paidPeriods: paidPeriods, 
                remainingPeriods: remainingPeriods, 
                remainingAmount: remainingAmount, 
                createdAt: existingIndex > -1 ? installments[existingIndex].createdAt : Date.now()
            };

            // æ›´æ–°æˆ–æ–°å¢æ•¸æ“š
            if (existingIndex > -1) {
                // ç·¨è¼¯: åƒ…æ›´æ–°å¯ç·¨è¼¯å­—æ®µ 
                installments[existingIndex] = { 
                    ...installments[existingIndex], 
                    item, 
                    cardId, 
                    transactionDate, 
                    postingDate 
                };
            } else {
                installments.push(installmentData);
            }

            installments.sort((a, b) => b.createdAt - a.createdAt);
            saveData(STORAGE_KEY_INSTALLMENTS, installments);
            displayInstallments();
            updateDashboardStats();
            displayCreditCards();
            closeModal('installmentModal');
        }

        /**
         * æ‰“é–‹åˆ†æœŸæ¨¡æ…‹æ¡†
         */
        function openInstallmentModal(installment = null) {
            // æª¢æŸ¥æ˜¯å¦æœ‰å¡ç‰‡
            if (cards.length === 0) {
                alert('è«‹å…ˆåœ¨ã€Œä¿¡ç”¨å¡ç®¡ç†ã€ä¸­æ–°å¢ä¸€å¼µä¿¡ç”¨å¡ï¼');
                return;
            }
            
            // æ¯æ¬¡é–‹å•Ÿå‰ï¼Œæ¸…ç©ºéŒ¯èª¤æç¤º
            document.getElementById('installmentError').classList.add('hidden');

            document.getElementById('modalTitle').textContent = installment ? 'ç·¨è¼¯æ¶ˆè²»åˆ†æœŸ' : 'æ–°å¢æ¶ˆè²»åˆ†æœŸ';
            document.getElementById('installmentId').value = installment ? installment.id : '';
            document.getElementById('item').value = installment ? installment.item : '';
            
            populateCardSelects(); // ç¢ºä¿ä¸‹æ‹‰é¸å–®æ˜¯æœ€æ–°çš„
            document.getElementById('cardId').value = installment ? installment.cardId : (cards[0] ? cards[0].id : '');
            
            const today = formatDate(new Date());
            document.getElementById('transactionDate').value = installment && installment.transactionDate ? installment.transactionDate : today;
            document.getElementById('postingDate').value = installment && installment.postingDate ? installment.postingDate : today;
            
            const isEdit = !!installment;
            
            // ç¸½é‡‘é¡ã€æœŸæ•¸ã€é¦–æœŸç¹³æ¬¾æœˆä»½åœ¨æ–°å¢å¾Œä¸å¯ç·¨è¼¯
            document.getElementById('amount').value = installment ? installment.totalAmount : '';
            document.getElementById('totalPeriods').value = installment ? installment.totalPeriods : '';
            document.getElementById('firstPaymentMonth').value = installment ? installment.firstPaymentMonth : formatMonth(new Date());
            
            document.getElementById('amount').disabled = isEdit;
            document.getElementById('totalPeriods').disabled = isEdit;
            document.getElementById('firstPaymentMonth').disabled = isEdit;
            
            document.getElementById('installmentModal').classList.remove('hidden');
        }

        /**
         * æ¸²æŸ“å–®å€‹åˆ†æœŸé …ç›®çš„è¼”åŠ©å‡½å¼ (Helper Function)
         */
        function renderInstallmentItem(item) {
            const card = cards.find(c => c.id === item.cardId);
            const cardName = card ? card.name : 'æœªçŸ¥å¡ç‰‡';
            const currencySymbol = card ? card.cardCurrency || 'NT$' : 'NT$';

            // --- é—œéµçš„æ—¥æœŸè¨ˆç®—å€å¡Š ---
            // é€™è£¡ä¸æœƒæ•æ‰éŒ¯èª¤ï¼Œå› ç‚º displayInstallments å¤–å±¤å·²ç¶“æ•æ‰äº†
            let nextPaymentDate = getNextPaymentDate(item.firstPaymentMonth, item.paidPeriods);
            
            const now = new Date();
            
            // ğŸ’¡ æ—¥æœŸä¿®æ­£ï¼šä½¿ç”¨å¡ç‰‡çš„ç¹³è²»æˆªæ­¢æ—¥ (cardDueDate) ä½œç‚ºé ä¼°æ‰£æ¬¾æ—¥
            const cardDueDate = card ? card.dueDate : 1; 
            let nextDueDate = new Date(nextPaymentDate.getFullYear(), nextPaymentDate.getMonth(), cardDueDate);
            
            const nextPaymentDisplay = `${nextDueDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })} (ç¹³è²»æˆªæ­¢æ—¥)`;
            
            const isOverdue = nextDueDate < now && item.remainingPeriods > 0;
            
            // --- è²¡å‹™æ•¸æ“š ---
            const monthlyPaymentSafe = parseFloat(item.monthlyPayment) || 0;
            const remainingAmountSafe = parseFloat(item.remainingAmount) || 0;
            
            const progressPercentage = item.totalPeriods > 0 
                ? ((item.paidPeriods / item.totalPeriods) * 100).toFixed(1) 
                : 0;

            return `
                <div id="installment-${item.id}" class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 hover:shadow-lg transition">
                    <div class="flex justify-between items-start">
                        <h4 class="text-lg font-semibold truncate max-w-[70%]">${item.item}</h4>
                        <span class="text-sm font-medium px-2 py-1 rounded-full bg-primary-dark dark:bg-primary-light text-white">${cardName}</span>
                    </div>
                    <div class="mt-2 text-sm space-y-1">
                        <p>å–®æœŸæ‡‰ç¹³é‡‘é¡: <span class="font-bold">${formatCurrency(monthlyPaymentSafe, currencySymbol)}</span></p>
                        <p>å‰©é¤˜æœŸæ•¸/ç¸½æœŸæ•¸: <span class="font-medium">${item.remainingPeriods} / ${item.totalPeriods}</span></p>
                        <p class="${isOverdue ? 'text-red-500 font-bold' : ''}">ä¸‹æœŸæ‰£æ¬¾é ä¼°: <span class="font-medium">${nextPaymentDisplay}</span></p>
                        <p>å‰©é¤˜ç¸½é‡‘é¡: <span class="font-bold text-red-600 dark:text-red-400">${formatCurrency(remainingAmountSafe, currencySymbol)}</span></p>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-3 mb-2">
                        <div class="h-2 rounded-full bg-green-500" style="width: ${progressPercentage}%"></div>
                    </div>
                    <p class="text-xs text-right text-gray-500 dark:text-gray-400">é€²åº¦: ${progressPercentage}% (æœŸ)</p>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button onclick="markPayment('${item.id}')" class="px-3 py-1 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition">ç¹³ä¸€æœŸ</button>
                        <button onclick="openInstallmentModal(installments.find(i => i.id === '${item.id}'))" class="px-3 py-1 text-sm bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 rounded-lg transition">ç·¨è¼¯</button>
                    </div>
                </div>
            `;
        }


        /**
         * è™•ç†ç¹³æ¬¾ä¸€æœŸ (å¼·åŒ– UI æ¸²æŸ“éŸ¿æ‡‰ - ä¿®æ­£ç•«é¢ä¸åˆ·æ–°å•é¡Œ)
         */
        function markPayment(id) {
            const itemIndex = installments.findIndex(i => i.id === id);
            if (itemIndex > -1) {
                let item = installments[itemIndex];
                
                if (item.remainingPeriods <= 0) {
                    alert('æ­¤åˆ†æœŸå·²ç¹³æ¸…ï¼Œè«‹å‹¿é‡è¤‡æ“ä½œã€‚');
                    return;
                }

                if (confirm(`ç¢ºèªç¹³äº¤é …ç›®ã€${item.item}ã€‘çš„ç¬¬ ${item.paidPeriods + 1} æœŸå—ï¼Ÿ`)) {
                    
                    // --- 1. æ•¸æ“šæ›´æ–° ---
                    item.paidPeriods += 1;
                    item.remainingPeriods -= 1;
                    // ä½¿ç”¨æ•¸å­¸é‹ç®—ä¾†é¿å…æµ®é»æ•¸èª¤å·® (ä½†ä»ä½¿ç”¨ toFixed(2) å„²å­˜)
                    item.remainingAmount = parseFloat((item.totalAmount - (item.monthlyPayment * item.paidPeriods)).toFixed(2));
                    
                    if (item.remainingPeriods <= 0 || item.remainingAmount < 0.01) {
                        item.remainingPeriods = 0;
                        item.remainingAmount = 0;
                        archiveInstallment(item.id); 
                    }

                    // --- 2. æ•¸æ“šå„²å­˜ (åŒæ­¥) ---
                    saveData(STORAGE_KEY_INSTALLMENTS, installments);
                    
                    // --- 3. é—œéµ UI æ¸²æŸ“éš”é›¢èˆ‡å»¶é² (ä¿®æ­£ UI å‡çµ) ---
                    // ä½¿ç”¨ requestAnimationFrame + setTimeout(0) å¼·åˆ¶å°‡ UI ä»»å‹™æ¨é²
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            displayInstallments();    // æ ¸å¿ƒåˆ—è¡¨é‡æ–°æ¸²æŸ“
                            updateDashboardStats();   // å„€è¡¨æ¿æ•¸æ“šæ›´æ–°
                            displayCreditCards();     // ä¿¡ç”¨å¡é¡åº¦æ›´æ–°

                            // è¦–è¦ºå›é¥‹ (å¯é¸)
                            const itemElement = document.getElementById(`installment-${item.id}`);
                            if (itemElement) {
                                 itemElement.style.transition = 'background-color 0.3s';
                                 itemElement.style.backgroundColor = 'rgba(144, 238, 144, 0.5)';
                                 setTimeout(() => {
                                     itemElement.style.backgroundColor = '';
                                 }, 300);
                            }
                        }, 0); // å»¶é² 0 æ¯«ç§’ï¼Œå°‡ä»»å‹™æ¨é²åˆ°ç€è¦½å™¨åŸ·è¡Œå®Œç•¶å‰æŒ‡ä»¤ä¹‹å¾Œ
                    });

                }
            }
        }
        
        /**
         * æ¸²æŸ“åˆ†æœŸåˆ—è¡¨ (é …ç›®ç´šåˆ¥çš„éŒ¯èª¤è™•ç†ï¼Œé˜²æ­¢å–®å€‹é …ç›®å´©æ½°æ•´å€‹åˆ—è¡¨)
         */
        function displayInstallments() {
            const list = document.getElementById('installmentsList');
            const noInstallments = document.getElementById('noInstallments');

            // å¤–éƒ¨ä¿è­·ï¼šé˜²æ­¢æ•´é«”éæ¿¾é‚è¼¯å´©æ½°
            try {
                const filterText = document.getElementById('filterText').value.toLowerCase();
                const filterCardId = document.getElementById('filterCard').value;

                const filtered = installments.filter(i => {
                    const card = cards.find(c => c.id === i.cardId);
                    const cardName = card ? card.name.toLowerCase() : '';
                    const itemMatch = i.item.toLowerCase().includes(filterText);
                    const cardMatch = cardName.includes(filterText);
                    const cardFilter = filterCardId ? i.cardId === filterCardId : true;

                    return (itemMatch || cardMatch) && cardFilter;
                });

                list.innerHTML = '';
                noInstallments.classList.toggle('hidden', filtered.length > 0);

                filtered.forEach(item => {
                    try {
                        list.innerHTML += renderInstallmentItem(item);
                    } catch (e) {
                        console.error(`æ¸²æŸ“é …ç›® [${item.item}] ç™¼ç”ŸéŒ¯èª¤:`, e);
                        // âŒ æ¸²æŸ“å¤±æ•—æ™‚ï¼Œé¡¯ç¤ºéŒ¯èª¤å¡ç‰‡å’Œå¼·åˆ¶åˆªé™¤æŒ‰éˆ•
                        list.innerHTML += `
                            <div class="p-4 bg-red-100 dark:bg-red-900/50 text-red-600 rounded-xl shadow-md border border-red-500/50">
                                <div class="flex justify-between items-start">
                                    <div>
                                         âŒ **é …ç›® [${item.item}] æ¸²æŸ“å¤±æ•—**ï¼šæ•¸æ“šå¯èƒ½æå£ã€‚
                                         <p class="text-xs mt-1">éŒ¯èª¤è©³æƒ…: ${e.message}</p>
                                    </div>
                                    <button onclick="deleteInstallment('${item.id}')" class="flex-shrink-0 text-xs px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md transition">å¼·åˆ¶åˆªé™¤</button>
                                </div>
                            </div>
                        `;
                    }
                });

            } catch (error) {
                // å¦‚æœæ•´å€‹ displayInstallments å‡½å¼å´©æ½°
                console.error("displayInstallments æ ¸å¿ƒé‚è¼¯ç™¼ç”ŸéŒ¯èª¤:", error);
                list.innerHTML = `<p class="p-4 bg-red-500 text-white rounded-lg">è‡´å‘½éŒ¯èª¤ï¼šç„¡æ³•é¡¯ç¤ºåˆ†æœŸåˆ—è¡¨ã€‚è«‹å˜—è©¦æ¸…é™¤ç¶²ç«™è³‡æ–™ã€‚</p>`;
            }
        }

        /**
         * åˆªé™¤åˆ†æœŸé …ç›® (ç”¨æ–¼ã€Œå¼·åˆ¶åˆªé™¤ã€æŒ‰éˆ•)
         */
        function deleteInstallment(id) {
            const item = installments.find(i => i.id === id);
            const itemName = item ? item.item : 'è©²é …ç›®';
            
            if (confirm(`ç¢ºèªè¦æ°¸ä¹…åˆªé™¤ã€${itemName}ã€‘é€™ç­†åˆ†æœŸè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚`)) {
                installments = installments.filter(i => i.id !== id);
                saveData(STORAGE_KEY_INSTALLMENTS, installments);
                displayInstallments();
                updateDashboardStats();
                displayCreditCards();
                alert(`é …ç›®ã€${itemName}ã€‘å·²æˆåŠŸåˆªé™¤ã€‚`);
            }
        }

        /**
         * æ­¸æª”å·²å®Œæˆçš„åˆ†æœŸé …ç›®
         */
        function archiveInstallment(id) {
            const itemIndex = installments.findIndex(i => i.id === id);
            if (itemIndex > -1) {
                const item = installments.splice(itemIndex, 1)[0];
                const card = cards.find(c => c.id === item.cardId);
                item.cardName = card ? card.name : 'æœªçŸ¥å¡ç‰‡';
                item.cardCurrency = card ? card.cardCurrency : 'NT$';
                item.archivedAt = Date.now();
                archive.unshift(item);
                saveData(STORAGE_KEY_ARCHIVE, archive);
                saveData(STORAGE_KEY_INSTALLMENTS, installments);
                displayArchive();
            }
        }

        /**
         * æ¸²æŸ“æ­¸æª”åˆ—è¡¨
         */
        function displayArchive() {
            const list = document.getElementById('archiveList');
            list.innerHTML = '';
            document.getElementById('noArchive').classList.toggle('hidden', archive.length > 0);

            archive.forEach(item => {
                 const archiveDate = new Date(item.archivedAt).toLocaleDateString('zh-TW', { year: 'numeric', month: 'short', day: 'numeric' });
                 
                 // ç¢ºä¿å¾æ­¸æª”æ•¸æ“šä¸­å–å¾—å¹£åˆ¥
                 const currencySymbol = item.cardCurrency || 'NT$'; 
                 
                 list.innerHTML += `
                     <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 opacity-75">
                         <div class="flex justify-between items-start">
                             <h4 class="text-lg font-semibold truncate max-w-[70%]">${item.item}</h4>
                             <span class="text-sm font-medium px-2 py-1 rounded-full bg-gray-500 text-white">${item.cardName} (${currencySymbol})</span>
                         </div>
                         <div class="mt-2 text-sm space-y-1 text-gray-600 dark:text-gray-400">
                             <p>ç¸½é‡‘é¡: ${formatCurrency(item.totalAmount, currencySymbol)} / ç¸½æœŸæ•¸: ${item.totalPeriods}</p>
                             <p>å®Œæˆæ–¼: ${archiveDate}</p>
                         </div>
                     </div>
                 `;
            });
        }


        // --- å„€è¡¨æ¿èˆ‡çµ±è¨ˆ (æœ€çµ‚å¼·åŒ–ç‰ˆæœ¬) ---

        /**
         * æ›´æ–°å„€è¡¨æ¿ä¸Šçš„çµ±è¨ˆæ•¸æ“š
         */
        function updateDashboardStats() {
            const totalMonthlyPaymentElement = document.getElementById('totalMonthlyPayment');
            const nextEstimatedDateElement = document.getElementById('nextEstimatedDate');
            
            try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0-11
                
                let totalPaymentByCurrency = {};
                let earliestNextPaymentDate = null;
                
                installments.forEach(item => {
                    if (item.remainingPeriods <= 0) return; // å¿½ç•¥å·²ç¹³æ¸…çš„

                    const card = cards.find(c => c.id === item.cardId);
                    const currencySymbol = card ? card.cardCurrency || 'NT$' : 'NT$' ;
                    
                    let nextPaymentDate;
                    try {
                        // å–å¾—ä¸‹ä¸€å€‹æ‡‰ç¹³æ¬¾æœˆä»½çš„æ—¥æœŸ (ä»¥ 15 è™Ÿä½œç‚ºè¨ˆç®—åŸºæº–)
                        nextPaymentDate = getNextPaymentDate(item.firstPaymentMonth, item.paidPeriods);
                        
                        // ğŸ’¡ æ—¥æœŸä¿®æ­£ï¼šæ ¹æ“šå¡ç‰‡çš„ç¹³è²»æˆªæ­¢æ—¥ (cardDueDate) èª¿æ•´ç‚ºå¯¦éš›æ‰£æ¬¾çš„é ä¼°æ—¥æœŸ
                        const cardDueDate = card ? card.dueDate : 1; 
                        nextPaymentDate.setDate(cardDueDate);
                        
                    } catch (dateError) {
                        console.error(`çµ±è¨ˆæ—¥æœŸè¨ˆç®—éŒ¯èª¤æ–¼é …ç›® ${item.item}:`, dateError);
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦æ˜¯ç•¶æœˆæ‡‰ç¹³ï¼Œä¸¦ä¾å¹£åˆ¥åˆ†çµ„
                    if (nextPaymentDate.getFullYear() === currentYear && nextPaymentDate.getMonth() === currentMonth) {
                        if (!totalPaymentByCurrency[currencySymbol]) {
                            totalPaymentByCurrency[currencySymbol] = 0;
                        }
                        const payment = parseFloat(item.monthlyPayment) || 0;
                        totalPaymentByCurrency[currencySymbol] += payment;
                    }

                    // æ‰¾å‡ºæœ€æ—©çš„ä¸‹ä¸€æ¬¡ç¹³æ¬¾æ—¥
                    if (!earliestNextPaymentDate || nextPaymentDate < earliestNextPaymentDate) {
                        earliestNextPaymentDate = nextPaymentDate;
                    }
                });
                
                const currencies = Object.keys(totalPaymentByCurrency);
                let totalPaymentDisplay;
                
                if (currencies.length === 0) {
                    totalPaymentDisplay = 'ç„¡';
                } else {
                    totalPaymentDisplay = currencies.map(c => 
                        formatCurrency(totalPaymentByCurrency[c], c)
                    ).join(' + ');
                }

                totalMonthlyPaymentElement.textContent = totalPaymentDisplay;

                // è™•ç†ä¸‹æœŸé ä¼°æ‰£æ¬¾æ—¥é¡¯ç¤º
                if (earliestNextPaymentDate) {
                    // å¦‚æœæœ€æ—©æ‰£æ¬¾æ—¥åœ¨ç•¶æœˆä¹‹å‰ï¼Œå¯èƒ½æ˜¯é¡¯ç¤ºéŒ¯èª¤ï¼Œä½†é€šå¸¸æˆ‘å€‘æœƒé¡¯ç¤ºæœ€æ—©çš„é‚£å€‹æ—¥æœŸ
                    const dateDisplay = earliestNextPaymentDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
                    nextEstimatedDateElement.textContent = dateDisplay;
                } else {
                    nextEstimatedDateElement.textContent = 'ç„¡å¾…ç¹³';
                }
                
                // --- æé†’è¨Šæ¯ ---
                const reminderContainer = document.getElementById('reminderContainer');
                const reminderMessage = document.getElementById('reminderMessage');

                if (earliestNextPaymentDate) {
                    const diffDays = Math.ceil((earliestNextPaymentDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 7 && diffDays > 0) {
                        reminderMessage.textContent = `ğŸš¨ æé†’ï¼šæœ€æ—©çš„ç¹³æ¬¾æ—¥ (${earliestNextPaymentDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })}) å³å°‡åˆ°ä¾†ï¼`;
                        reminderContainer.classList.remove('hidden');
                        reminderContainer.classList.add('reminder-pulse');
                    } else if (diffDays <= 0) {
                        reminderMessage.textContent = `âŒ æé†’ï¼šæ‚¨æœ‰åˆ†æœŸé …ç›®å·²éæœŸï¼è«‹ç«‹å³è™•ç†ã€‚`;
                        reminderContainer.classList.remove('hidden');
                        reminderContainer.classList.remove('reminder-pulse');
                    } else {
                        reminderContainer.classList.add('hidden');
                        reminderContainer.classList.remove('reminder-pulse');
                    }
                } else {
                    reminderContainer.classList.add('hidden');
                    reminderContainer.classList.remove('reminder-pulse');
                }


            } catch (e) {
                console.error("æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                totalMonthlyPaymentElement.textContent = 'è¨ˆç®—éŒ¯èª¤';
                nextEstimatedDateElement.textContent = 'è¨ˆç®—éŒ¯èª¤';
            }
        }


        // --- å•Ÿå‹• ---
        window.onload = initializeApp;
        
    </script>
</body>
</html>
