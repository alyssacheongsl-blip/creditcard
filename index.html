<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡ç”¨å¡åˆ†æœŸè¿½è¹¤ PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e40af', // è—è‰²
                        'primary-light': '#3b82f6', // æ·ºè—
                        'bg-dark': '#111827', // å¹¾ä¹é»‘è‰²
                        'bg-light': '#f3f4f6', // å¹¾ä¹ç™½è‰²
                        'card-dark': '#1f2937', // æ·±ç°
                        'card-light': '#ffffff', // ç™½è‰²
                    }
                }
            }
        }
    </script>

    <style>
        /* éš±è— Chrome/Safari çš„æ»¾å‹•æ¢ */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç¢ºä¿ PWA çš„å…¨è¢å¹•é«”é©— */
        .app-container { min-height: 100vh; }
        
        /* èª¿æ•´è¼¸å…¥æ¡†æ¨£å¼ä»¥é©æ‡‰æ·±æ·ºæ¨¡å¼ */
        input[type="text"], input[type="number"], select, input[type="month"], input[type="date"] {
            @apply bg-card-light dark:bg-card-dark border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-gray-100;
        }
        
        /* PWA æé†’æ’ç¨‹çš„å‹•ç•« */
        @keyframes pulse-ring {
            0% { transform: scale(.3); opacity: 0; }
            50% { opacity: .7; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .reminder-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            z-index: 0;
        }
        
        /* ç¢ºä¿æ´»å‹• Tab æ¨£å¼æ­£ç¢º */
        .active-tab {
            @apply bg-primary-dark dark:bg-primary-light text-white;
        }
    </style>
</head>

<body class="bg-bg-light dark:bg-bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="app" class="app-container max-w-xl mx-auto p-4 sm:p-6 pb-20">

        <header class="flex justify-between items-center mb-6 pt-2">
            <h1 class="text-3xl font-bold text-primary-dark dark:text-primary-light">ğŸ’³ åˆ†æœŸè¿½è¹¤</h1>
            <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <svg id="themeIcon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            </button>
        </header>
        
        <div class="flex space-x-2 mb-4 p-1 bg-gray-200 dark:bg-gray-800 rounded-lg">
            <button id="tab-dashboard" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700">å„€è¡¨æ¿</button>
            <button id="tab-credit-cards" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700">ä¿¡ç”¨å¡ç®¡ç†</button>
            <button id="tab-archive" class="flex-1 py-2 text-sm font-medium rounded-md transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700">æ­¸æª”</button>
        </div>
        
        <div id="dashboard-view" class="tab-content hidden">
            
            <section class="mb-6 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-3 border-b pb-2 border-gray-200 dark:border-gray-700">ğŸ“Š æœ¬æœˆæ¦‚æ³</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-red-500" id="totalMonthlyPayment">Â¥0</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ç•¶æœˆç¸½ç¹³æ¬¾é¡</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-500" id="nextEstimatedDate">N/A</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ä¸‹æœŸé ä¼°æ‰£æ¬¾æ—¥</p>
                    </div>
                </div>
            </section>
            
            <div class="mb-4 flex space-x-2">
                <input type="text" id="filterText" placeholder="æœå°‹é …ç›®æˆ–å¡ç‰‡..." class="flex-grow p-2 rounded-lg" oninput="displayInstallments()">
                <select id="filterCard" class="p-2 rounded-lg" onchange="displayInstallments()">
                    <option value="">æ‰€æœ‰å¡ç‰‡</option>
                </select>
            </div>
            
            <div id="reminderContainer" class="p-3 mb-4 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 rounded-lg hidden">
                <p id="reminderMessage" class="font-medium"></p>
            </div>
            
            <section>
                <h2 class="text-xl font-semibold mb-3">å¾…ç¹³åˆ†æœŸ</h2>
                <div id="installmentsList" class="space-y-4">
                    <p id="noInstallments" class="text-center text-gray-500 dark:text-gray-400">ç›®å‰æ²’æœ‰å¾…ç¹³åˆ†æœŸã€‚</p>
                </div>
            </section>
            
            <button id="openNewInstallmentModal" class="fixed bottom-4 right-4 z-10 w-14 h-14 bg-primary-dark dark:bg-primary-light text-white rounded-full shadow-xl flex items-center justify-center text-3xl font-light hover:scale-105 transition-transform duration-200" title="æ–°å¢æ¶ˆè²»">+</button>

        </div>
        
        <div id="credit-cards-view" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ’³ ä¿¡ç”¨å¡ç®¡ç†</h2>
            <div id="creditCardsList" class="space-y-3 mb-6">
                <p id="noCards" class="text-center text-gray-500 dark:text-gray-400">ç›®å‰æ²’æœ‰æ–°å¢å¡ç‰‡ã€‚</p>
            </div>
            <button id="openNewCardModal" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow transition">æ–°å¢ä¿¡ç”¨å¡</button>
        </div>

        <div id="archive-view" class="tab-content hidden">
             <h2 class="text-2xl font-bold mb-4">ğŸ—„ï¸ å·²ç¹³æ¸…æ­¸æª”</h2>
             <div id="archiveList" class="space-y-4">
                 <p id="noArchive" class="text-center text-gray-500 dark:text-gray-400">æ­¸æª”å€ç›®å‰æ˜¯ç©ºçš„ã€‚</p>
             </div>
        </div>

    </div>
    
    <div id="installmentModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4 z-20 hidden">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">æ–°å¢æ¶ˆè²»åˆ†æœŸ</h3>
            <form id="installmentForm" class="space-y-4">
                <input type="hidden" id="installmentId">
                <div>
                    <label for="item" class="block text-sm font-medium mb-1">æ¶ˆè²»é …ç›®</label>
                    <input type="text" id="item" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="cardId" class="block text-sm font-medium mb-1">é¸æ“‡ä¿¡ç”¨å¡</label>
                    <select id="cardId" required class="w-full p-2 border rounded-lg">
                        </select>
                </div>
                <div>
                    <label for="transactionDate" class="block text-sm font-medium mb-1">æ¶ˆè²»æ—¥ (äº¤æ˜“æ—¥)</label>
                    <input type="date" id="transactionDate" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="postingDate" class="block text-sm font-medium mb-1">å…¥å¸³æ—¥ (å…¥å¸³èµ·æ¯æ—¥)</label>
                    <input type="date" id="postingDate" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium mb-1">ç¸½é‡‘é¡ (Â¥)</label>
                    <input type="number" id="amount" required min="1" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="totalPeriods" class="block text-sm font-medium mb-1">åˆ†æœŸæœŸæ•¸ (æœˆ)</label>
                    <input type="number" id="totalPeriods" required min="1" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="firstPaymentMonth" class="block text-sm font-medium mb-1">é¦–æœŸç¹³æ¬¾æœˆä»½</label>
                    <input type="month" id="firstPaymentMonth" required class="w-full p-2 border rounded-lg">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeModal('installmentModal')" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-primary-dark dark:bg-primary-light text-white rounded-lg hover:opacity-90 transition">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4 z-20 hidden">
        <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4">æ–°å¢/ç·¨è¼¯ä¿¡ç”¨å¡</h3>
            <form id="cardForm" class="space-y-4">
                <input type="hidden" id="cardFormId">
                <div>
                    <label for="cardName" class="block text-sm font-medium mb-1">éŠ€è¡Œ/å¡ç‰‡åç¨±</label>
                    <input type="text" id="cardName" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="cardLimit" class="block text-sm font-medium mb-1">ä¿¡ç”¨é¡åº¦ (Â¥)</label>
                    <input type="number" id="cardLimit" required min="0" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="cardAnnualFee" class="block text-sm font-medium mb-1">å¹´è²» (Â¥) (æ¯”è¼ƒæˆæœ¬ç”¨)</label>
                    <input type="number" id="cardAnnualFee" value="0" min="0" class="w-full p-2 border rounded-lg">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeModal('cardModal')" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-primary-dark dark:bg-primary-light text-white rounded-lg hover:opacity-90 transition">å„²å­˜å¡ç‰‡</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const STORAGE_KEY_INSTALLMENTS = 'pwa_installments_v2';
        const STORAGE_KEY_CARDS = 'pwa_credit_cards_v2';
        const STORAGE_KEY_ARCHIVE = 'pwa_archive_v2';
        const STORAGE_KEY_THEME = 'pwa_theme';

        let installments = [];
        let cards = [];
        let archive = [];
        
        // --- é€šç”¨å·¥å…·å‡½æ•¸ ---

        /**
         * è®€å– localStorage æ•¸æ“š
         */
        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error(`Error loading data for key: ${key}`, error);
                return [];
            }
        }

        /**
         * å„²å­˜æ•¸æ“šåˆ° localStorage (å¼·åŒ–éŒ¯èª¤æç¤º)
         */
        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`FATAL ERROR: Failed to save data for key: ${key}. Error:`, error);
                // é€™æ˜¯é—œéµçš„è­¦ç¤ºï¼Œå¦‚æœå„²å­˜å¤±æ•—ï¼Œæœƒå½ˆå‡ºæç¤º
                alert(`å„²å­˜æ•¸æ“šå¤±æ•—ï¼å¯èƒ½æ˜¯æ‚¨çš„è£ç½®å„²å­˜ç©ºé–“å·²æ»¿æˆ–ç€è¦½å™¨éš±ç§è¨­å®šé˜»æ­¢äº†å„²å­˜ã€‚éŒ¯èª¤è©³æƒ…: ${error.message}`);
            }
        }

        /**
         * æ ¼å¼åŒ–é‡‘é¡ç‚ºè²¨å¹£å­—ä¸² (ç°¡åŒ–ç‚º Â¥)
         */
        function formatCurrency(amount) {
            return `Â¥${(amount || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        }
        
        /**
         * æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM
         */
        function formatMonth(date) {
            return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        }
        
        /**
         * âœ¨ æ–°å¢ï¼šæ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
         */
        function formatDate(date) {
             const d = new Date(date);
             return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        /**
         * ç²å–ä¸‹ä¸€å€‹ç¹³æ¬¾æœˆä»½çš„ Date å°è±¡
         */
        function getNextPaymentDate(firstPaymentMonth, paidPeriods) {
            const [year, month] = firstPaymentMonth.split('-').map(Number);
            const nextDate = new Date(year, month - 1 + paidPeriods, 15);
            return new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 15);
        }
        
        /**
         * é—œé–‰ä»»ä¸€æ¨¡æ…‹æ¡†
         */
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨é‚è¼¯ ---

        function initializeApp() {
            installments = loadData(STORAGE_KEY_INSTALLMENTS);
            cards = loadData(STORAGE_KEY_CARDS);
            archive = loadData(STORAGE_KEY_ARCHIVE);
            
            setupEventHandlers();
            loadTheme();
            displayCreditCards();
            populateCardSelects();
            displayInstallments();
            displayArchive();
            updateDashboardStats();
            checkReminders();
            // é è¨­åˆ‡æ›åˆ°å„€è¡¨æ¿ï¼Œç¢ºä¿ UI ç‹€æ…‹æ­£ç¢º
            switchTab('dashboard'); 
        }
        
        function setupEventHandlers() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            document.getElementById('tab-dashboard').addEventListener('click', () => switchTab('dashboard'));
            document.getElementById('tab-credit-cards').addEventListener('click', () => switchTab('credit-cards'));
            document.getElementById('tab-archive').addEventListener('click', () => switchTab('archive'));

            document.getElementById('openNewInstallmentModal').addEventListener('click', () => openInstallmentModal());
            document.getElementById('installmentForm').addEventListener('submit', handleInstallmentSubmit);
            
            document.getElementById('openNewCardModal').addEventListener('click', () => openCardModal());
            document.getElementById('cardForm').addEventListener('submit', handleCardSubmit);
            
            if ('serviceWorker' in navigator) {
                 navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered successfully. Scope: ' + reg.scope))
                    .catch(err => console.error('Service Worker registration failed:', err));
            }
        }
        
        // --- ä¸»é¡Œåˆ‡æ› (æ·ºè‰²/æ·±è‰²æ¨¡å¼) ---

        function loadTheme() {
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            
            if (theme === 'dark') {
                html.classList.add('dark');
                // æ›¿æ›ç‚ºå¤ªé™½åœ–ç¤º
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707M12 6v6l2 2m-2-4l-2 2"></path>';
            } else {
                html.classList.remove('dark');
                // æ›¿æ›ç‚ºæœˆäº®åœ–ç¤º
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
            localStorage.setItem(STORAGE_KEY_THEME, theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        }

        // --- Tab å°èˆª (ä¿®æ­£ï¼šç¢ºä¿è®Šæ•¸åç¨±æ­£ç¢ºï¼Œé¿å… UI éŒ¯èª¤) ---

        function switchTab(tabName) {
            ['dashboard', 'credit-cards', 'archive'].forEach(name => {
                const view = document.getElementById(`${name}-view`); 
                const tabButton = document.getElementById(`tab-${name}`); 
                
                if (view && tabButton) { 
                    view.classList.add('hidden');
                    tabButton.classList.remove('active-tab', 'bg-primary-dark', 'dark:bg-primary-light', 'text-white');
                    tabButton.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-700');
                }
            });

            const activeView = document.getElementById(`${tabName}-view`); 
            const activeTabButton = document.getElementById(`tab-${tabName}`); 
            
            if (activeView && activeTabButton) {
                activeView.classList.remove('hidden');
                activeTabButton.classList.add('active-tab', 'bg-primary-dark', 'dark:bg-primary-light', 'text-white');
                activeTabButton.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-700');
            }
        }

        // --- ä¿¡ç”¨å¡ç®¡ç† ---

        /**
         * è™•ç†æ–°å¢/ç·¨è¼¯ä¿¡ç”¨å¡è¡¨å–®æäº¤ (ä¿®æ­£ï¼šåš´æ ¼è§£æã€éŒ¯èª¤æ•ç²ã€æ­£ç¢ºåˆ·æ–° UI)
         */
        function handleCardSubmit(e) {
            e.preventDefault();
            
            try {
                const id = document.getElementById('cardFormId').value || `card-${Date.now()}`;
                const name = document.getElementById('cardName').value.trim();
                // ç¢ºä¿ä½¿ç”¨ parseFloat å’Œ trim() ä¾†è™•ç†å¯èƒ½çš„ç©ºæ ¼å’Œéæ•¸å­—è¼¸å…¥
                const limit = parseFloat(document.getElementById('cardLimit').value.trim()) || 0; 
                const annualFee = parseFloat(document.getElementById('cardAnnualFee').value.trim()) || 0;
                
                
                // æ ¸å¿ƒé©—è­‰
                if (!name) {
                    alert('éŒ¯èª¤ï¼šè«‹å¡«å¯«ã€ŒéŠ€è¡Œ/å¡ç‰‡åç¨±ã€ã€‚');
                    return;
                }
                // åŒæ™‚æª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­— (isNaN) å’Œæ˜¯å¦å¤§æ–¼ 0
                if (isNaN(limit) || limit <= 0) {
                    alert('éŒ¯èª¤ï¼šä¿¡ç”¨é¡åº¦å¿…é ˆæ˜¯æœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0ã€‚');
                    return;
                }

                const existingIndex = cards.findIndex(c => c.id === id);
                
                if (existingIndex > -1) {
                    cards[existingIndex] = { ...cards[existingIndex], name, limit, annualFee };
                } else {
                    cards.push({ id, name, limit, annualFee });
                }

                // æ ¹æ“šé¡åº¦æ’åº
                cards.sort((a, b) => b.limit - a.limit);

                // æ­¥é©Ÿ 1: å„²å­˜æ•¸æ“š (å¦‚æœå„²å­˜å¤±æ•—ï¼ŒsaveData å…§æœƒå½ˆå‡º alert)
                saveData(STORAGE_KEY_CARDS, cards);
                
                // æ­¥é©Ÿ 2: UI åˆ·æ–° (ä¿®æ­£å¾Œçš„ displayCreditCards å°‡ä¸å†å ±éŒ¯)
                displayCreditCards();
                populateCardSelects();
                updateDashboardStats(); 
                
                // æ­¥é©Ÿ 3: é—œé–‰æ¨¡æ…‹æ¡† (ç¢ºèªåœ¨æ‰€æœ‰æ“ä½œå®Œæˆå¾ŒåŸ·è¡Œ)
                closeModal('cardModal');
                
            } catch (error) {
                // å¦‚æœåœ¨è™•ç†æµç¨‹ä¸­ç™¼ç”Ÿä»»ä½•éŒ¯èª¤ï¼Œå½ˆå‡ºè­¦ç¤ºä¸¦è¨˜éŒ„
                console.error('handleCardSubmit ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('å¡ç‰‡è™•ç†å¤±æ•—ï¼è«‹æª¢æŸ¥è¼¸å…¥å€¼ã€‚éŒ¯èª¤è©³æƒ…: ' + error.message);
            }
        }
        
        /**
         * æ‰“é–‹ä¿¡ç”¨å¡æ¨¡æ…‹æ¡†
         */
        function openCardModal(card = null) {
            document.getElementById('cardFormId').value = card ? card.id : '';
            document.getElementById('cardName').value = card ? card.name : '';
            document.getElementById('cardLimit').value = card ? card.limit : 0;
            document.getElementById('cardAnnualFee').value = card ? card.annualFee : 0;
            document.getElementById('cardModal').classList.remove('hidden');
        }
        
        /**
         * æ¸²æŸ“ä¿¡ç”¨å¡åˆ—è¡¨ (âœ¨ ä¿®æ­£äº†ç•¶å‰ Tab ä¸åœ¨ Credit Card æ™‚æœƒå‡ºç¾çš„ null éŒ¯èª¤)
         */
        function displayCreditCards() {
            const list = document.getElementById('creditCardsList');
            const noCardsElement = document.getElementById('noCards');
            
            // ä¿®æ­£ï¼šæª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å… null éŒ¯èª¤
            if (!list || !noCardsElement) return;

            list.innerHTML = '';
            noCardsElement.classList.toggle('hidden', cards.length > 0);

            cards.forEach(card => {
                const usedLimit = installments.filter(i => i.cardId === card.id).reduce((sum, i) => sum + i.remainingAmount, 0);
                const availableLimit = card.limit - usedLimit;
                const percentage = card.limit > 0 ? ((usedLimit / card.limit) * 100).toFixed(1) : 0;
                
                const costDisplay = card.annualFee > 0 ? `å¹´è²»: ${formatCurrency(card.annualFee)}` : `å¹´è²»: ç„¡`;
                
                list.innerHTML += `
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-lg font-semibold">${card.name}</h4>
                            <div class="space-x-2">
                                <button onclick="openCardModal(cards.find(c => c.id === '${card.id}'))" class="text-sm text-primary-dark dark:text-primary-light hover:underline">ç·¨è¼¯é¡åº¦</button>
                                <button onclick="deleteCard('${card.id}')" class="text-sm text-red-500 hover:underline">åˆªé™¤</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${costDisplay}</p>
                        <div class="text-sm">
                            <p>ç¸½é¡åº¦: <span class="font-medium">${formatCurrency(card.limit)}</span></p>
                            <p>å‰©é¤˜é¡åº¦: <span class="font-medium ${availableLimit < 0 ? 'text-red-500' : 'text-green-500'}">${formatCurrency(availableLimit)}</span></p>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2">
                            <div class="h-2.5 rounded-full ${percentage > 75 ? 'bg-red-500' : percentage > 50 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-xs text-right mt-1 text-gray-500 dark:text-gray-400">${percentage}% å·²ä½¿ç”¨</p>
                    </div>
                `;
            });
        }
        
        /**
         * åˆªé™¤å¡ç‰‡
         */
        function deleteCard(id) {
            if (installments.some(i => i.cardId === id)) {
                alert('æ­¤å¡ç‰‡å°šæœ‰åˆ†æœŸæ¬¾é …æœªç¹³æ¸…ï¼Œè«‹å…ˆè™•ç†æˆ–åˆªé™¤ç›¸é—œåˆ†æœŸé …ç›®ã€‚');
                return;
            }
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µä¿¡ç”¨å¡å—ï¼Ÿ')) {
                cards = cards.filter(c => c.id !== id);
                saveData(STORAGE_KEY_CARDS, cards);
                displayCreditCards();
                populateCardSelects();
            }
        }

        /**
         * å¡«å……ä¿¡ç”¨å¡ä¸‹æ‹‰é¸å–® (æ–°å¢æ¶ˆè²»å’Œéæ¿¾)
         */
        function populateCardSelects() {
            const selects = [document.getElementById('cardId'), document.getElementById('filterCard')];
            
            selects.forEach(select => {
                const isFilter = select.id === 'filterCard';
                const selectedValue = select.value;
                
                select.innerHTML = '';
                if (isFilter) {
                    select.innerHTML = '<option value="">æ‰€æœ‰å¡ç‰‡</option>';
                }
                
                cards.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.id;
                    option.textContent = card.name;
                    select.appendChild(option);
                });
                
                select.value = selectedValue; // ä¿æŒé¸ä¸­å€¼
            });

            // å¦‚æœæ²’æœ‰å¡ç‰‡ï¼Œç¦ç”¨æ–°å¢åˆ†æœŸçš„æŒ‰éˆ•
            const openButton = document.getElementById('openNewInstallmentModal');
            if (openButton) {
                openButton.disabled = cards.length === 0;
            }
            
            const cardIdSelect = document.getElementById('cardId');
            if (cards.length === 0 && cardIdSelect) {
                 // ç¢ºä¿ cardId ä¸‹æ‹‰é¸å–®ä¸­é¡¯ç¤ºæç¤º
                 cardIdSelect.innerHTML = '<option value="" disabled selected>è«‹å…ˆæ–°å¢ä¿¡ç”¨å¡</option>';
            }
        }
        
        // --- åˆ†æœŸé …ç›®ç®¡ç† ---

        /**
         * è™•ç†æ–°å¢/ç·¨è¼¯åˆ†æœŸè¡¨å–®æäº¤
         */
        function handleInstallmentSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('installmentId').value || `inst-${Date.now()}`;
            const item = document.getElementById('item').value.trim();
            const cardId = document.getElementById('cardId').value;
            // âœ¨ æ–°å¢ï¼šç²å–å…©å€‹æ—¥æœŸæ¬„ä½çš„å€¼ (YYYY-MM-DD)
            const transactionDate = document.getElementById('transactionDate').value;
            const postingDate = document.getElementById('postingDate').value;
            
            const amount = parseFloat(document.getElementById('amount').value.trim()); 
            const totalPeriods = parseInt(document.getElementById('totalPeriods').value.trim()); 
            const firstPaymentMonth = document.getElementById('firstPaymentMonth').value; // YYYY-MM
            
            if (!cardId || isNaN(amount) || amount <= 0 || isNaN(totalPeriods) || totalPeriods <= 0 || !transactionDate || !postingDate) {
                alert('è«‹æª¢æŸ¥æ‰€æœ‰è¼¸å…¥æ¬„ä½ï¼šå¡ç‰‡ã€é‡‘é¡ã€æœŸæ•¸ã€æ¶ˆè²»æ—¥å’Œå…¥å¸³æ—¥çš†ç‚ºå¿…å¡«ä¸”é ˆç‚ºæœ‰æ•ˆæ•¸å­—/æ—¥æœŸã€‚');
                return;
            }

            const existingIndex = installments.findIndex(i => i.id === id);
            
            let installmentData = {
                id,
                item,
                cardId,
                transactionDate, // âœ¨ å„²å­˜ï¼šæ¶ˆè²»æ—¥
                postingDate,     // âœ¨ å„²å­˜ï¼šå…¥å¸³æ—¥
                totalAmount: amount,
                totalPeriods,
                firstPaymentMonth,
                monthlyPayment: parseFloat((amount / totalPeriods).toFixed(2)),
                paidPeriods: 0,
                remainingPeriods: totalPeriods,
                remainingAmount: amount,
                createdAt: existingIndex > -1 ? installments[existingIndex].createdAt : Date.now()
            };

            if (existingIndex > -1) {
                // ç·¨è¼¯: å…è¨±ç·¨è¼¯é …ç›®åç¨±ã€å¡ç‰‡ã€æ¶ˆè²»æ—¥å’Œå…¥å¸³æ—¥
                installments[existingIndex] = { 
                    ...installments[existingIndex], 
                    item, 
                    cardId,
                    transactionDate, // âœ¨ æ›´æ–°ï¼šæ¶ˆè²»æ—¥
                    postingDate      // âœ¨ æ›´æ–°ï¼šå…¥å¸³æ—¥
                };
            } else {
                installments.push(installmentData);
            }

            installments.sort((a, b) => b.createdAt - a.createdAt); // æœ€æ–°åœ¨æœ€ä¸Šé¢
            
            saveData(STORAGE_KEY_INSTALLMENTS, installments);
            displayInstallments();
            updateDashboardStats();
            displayCreditCards();
            closeModal('installmentModal');
        }
        
        /**
         * æ‰“é–‹åˆ†æœŸæ¨¡æ…‹æ¡†
         */
        function openInstallmentModal(installment = null) {
            if (cards.length === 0) {
                alert('è«‹å…ˆåœ¨ã€Œä¿¡ç”¨å¡ç®¡ç†ã€ä¸­æ–°å¢ä¸€å¼µä¿¡ç”¨å¡ï¼');
                return;
            }
            
            document.getElementById('modalTitle').textContent = installment ? 'ç·¨è¼¯æ¶ˆè²»åˆ†æœŸ' : 'æ–°å¢æ¶ˆè²»åˆ†æœŸ';
            document.getElementById('installmentId').value = installment ? installment.id : '';
            document.getElementById('item').value = installment ? installment.item : '';
            document.getElementById('cardId').value = installment ? installment.cardId : (cards[0] ? cards[0].id : ''); 
            
            // âœ¨ è¨­ç½®æ–°æ¬„ä½çš„å€¼
            document.getElementById('transactionDate').value = installment ? installment.transactionDate : formatDate(new Date()); 
            document.getElementById('postingDate').value = installment ? installment.postingDate : formatDate(new Date()); 
            
            const isEdit = !!installment;
            // ç·¨è¼¯æ™‚ï¼Œç¦ç”¨æ ¸å¿ƒé‡‘é¡å’ŒæœŸæ•¸æ¬„ä½ (ä¸å…è¨±ç·¨è¼¯æ ¸å¿ƒé‡‘é¡/æœŸæ•¸)
            document.getElementById('amount').value = installment ? installment.totalAmount : '';
            document.getElementById('totalPeriods').value = installment ? installment.totalPeriods : '';
            document.getElementById('firstPaymentMonth').value = installment ? installment.firstPaymentMonth : formatMonth(new Date());
            
            document.getElementById('amount').disabled = isEdit;
            document.getElementById('totalPeriods').disabled = isEdit;
            document.getElementById('firstPaymentMonth').disabled = isEdit;
            
            document.getElementById('installmentModal').classList.remove('hidden');
        }
        
        /**
         * æ¸²æŸ“åˆ†æœŸåˆ—è¡¨ (åŒ…å«æœå°‹/éæ¿¾)
         */
        function displayInstallments() {
            const list = document.getElementById('installmentsList');
            const filterText = document.getElementById('filterText').value.toLowerCase();
            const filterCardId = document.getElementById('filterCard').value;
            list.innerHTML = '';

            const filtered = installments.filter(i => {
                const card = cards.find(c => c.id === i.cardId);
                const cardName = card ? card.name.toLowerCase() : '';
                const itemMatch = i.item.toLowerCase().includes(filterText);
                const cardMatch = cardName.includes(filterText);
                const cardFilter = filterCardId ? i.cardId === filterCardId : true;
                return (itemMatch || cardMatch) && cardFilter;
            });
            
            document.getElementById('noInstallments').classList.toggle('hidden', filtered.length > 0);

            filtered.forEach(item => {
                const card = cards.find(c => c.id === item.cardId);
                const nextPaymentDate = getNextPaymentDate(item.firstPaymentMonth, item.paidPeriods);
                const nextPaymentMonth = formatMonth(nextPaymentDate);
                const isOverdue = nextPaymentDate < new Date() && item.remainingPeriods > 0;
                
                const cardName = card ? card.name : 'æœªçŸ¥å¡ç‰‡';
                const progressPercentage = ((item.paidPeriods / item.totalPeriods) * 100).toFixed(0);

                list.innerHTML += `
                    <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <h4 class="text-lg font-semibold truncate max-w-[70%]">${item.item}</h4>
                            <span class="text-sm font-medium px-2 py-1 rounded-full ${isOverdue ? 'bg-red-500 text-white' : 'bg-primary-dark/10 dark:bg-primary-light/20 text-primary-dark dark:text-primary-light'}">${cardName}</span>
                        </div>
                        
                        <div class="mt-2 text-xs space-y-1 text-gray-500 dark:text-gray-400">
                            <p>æ¶ˆè²»æ—¥: ${item.transactionDate || 'N/A'} / å…¥å¸³æ—¥: ${item.postingDate || 'N/A'}</p>
                            <p>é¦–æœŸé ä¼°æœˆä»½: ${item.firstPaymentMonth}</p>
                        </div>

                        <div class="mt-2 text-sm space-y-1">
                            <p>å–®æœŸæ‡‰ç¹³é‡‘é¡: <span class="font-bold">${formatCurrency(item.monthlyPayment)}</span></p>
                            <p>å‰©é¤˜æœŸæ•¸/ç¸½æœŸæ•¸: <span class="font-medium">${item.remainingPeriods} / ${item.totalPeriods}</span></p>
                            <p class="${isOverdue ? 'text-red-500 font-bold' : ''}">ä¸‹æœŸæ‰£æ¬¾é ä¼°: <span class="font-medium">${nextPaymentMonth}</span></p>
                            <p>å‰©é¤˜ç¸½é‡‘é¡: <span class="font-bold text-red-600 dark:text-red-400">${formatCurrency(item.remainingAmount)}</span></p>
                        </div>
                        
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-3 mb-2">
                            <div class="h-2 rounded-full bg-green-500" style="width: ${progressPercentage}%"></div>
                        </div>
                        <p class="text-xs text-right text-gray-500 dark:text-gray-400">é€²åº¦: ${progressPercentage}% (æœŸ)</p>
                        
                        <div class="flex justify-end space-x-2 mt-4">
                            <button onclick="markPayment('${item.id}')" class="px-3 py-1 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition">ç¹³ä¸€æœŸ</button>
                            <button onclick="openInstallmentModal(installments.find(i => i.id === '${item.id}'))" class="px-3 py-1 text-sm bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 rounded-lg transition">ç·¨è¼¯</button>
                        </div>
                    </div>
                `;
            });
        }
        
        /**
         * é€ç­†æ¸›å°‘ (ç¹³ä¸€æœŸ)
         */
        function markPayment(id) {
            const index = installments.findIndex(i => i.id === id);
            if (index === -1) return;

            const item = installments[index];
            
            let newRemainingAmount = item.remainingAmount - item.monthlyPayment;
            let newRemainingPeriods = item.remainingPeriods - 1;
            let newPaidPeriods = item.paidPeriods + 1;
            
            if (newRemainingPeriods === 0 || newRemainingAmount < 0) {
                newRemainingAmount = 0; 
            }

            item.paidPeriods = newPaidPeriods;
            item.remainingPeriods = newRemainingPeriods;
            item.remainingAmount = newRemainingAmount;

            if (item.remainingPeriods <= 0) {
                archiveItem(item);
                installments.splice(index, 1);
            } else {
                installments[index] = item;
            }
            
            saveData(STORAGE_KEY_INSTALLMENTS, installments);
            displayInstallments();
            updateDashboardStats();
            displayCreditCards();
        }
        
        // --- å„€è¡¨æ¿èˆ‡çµ±è¨ˆ ---

        /**
         * æ›´æ–°å„€è¡¨æ¿ä¸Šçš„çµ±è¨ˆæ•¸æ“š
         */
        function updateDashboardStats() {
            let totalPayment = 0;
            let earliestNextPaymentDate = null;
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); 

            installments.forEach(item => {
                const nextPaymentDate = getNextPaymentDate(item.firstPaymentMonth, item.paidPeriods);
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯ç•¶æœˆæ‡‰ç¹³ (ä½¿ç”¨ nextPaymentDate çš„æœˆå’Œå¹´)
                if (nextPaymentDate.getFullYear() === currentYear && nextPaymentDate.getMonth() === currentMonth) {
                    totalPayment += item.monthlyPayment;
                }
                
                // æ‰¾å‡ºæœ€æ—©çš„ä¸‹ä¸€æ¬¡ç¹³æ¬¾æ—¥ (åªè€ƒæ…®æœªä¾†çš„é …ç›®)
                if (nextPaymentDate > now) {
                    if (!earliestNextPaymentDate || nextPaymentDate < earliestNextPaymentDate) {
                        earliestNextPaymentDate = nextPaymentDate;
                    }
                }
            });

            document.getElementById('totalMonthlyPayment').textContent = formatCurrency(totalPayment);
            
            if (earliestNextPaymentDate) {
                document.getElementById('nextEstimatedDate').textContent = new Date(earliestNextPaymentDate).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
            } else {
                document.getElementById('nextEstimatedDate').textContent = 'ç„¡å¾…ç¹³';
            }
        }
        
        // --- æé†’ (æ’ç¨‹) ---

        /**
         * æª¢æŸ¥æ˜¯å¦æœ‰å³å°‡åˆ°æœŸçš„åˆ†æœŸ
         */
        function checkReminders() {
            const reminderContainer = document.getElementById('reminderContainer');
            const reminderMessage = document.getElementById('reminderMessage');
            
            const now = new Date();
            const alertDays = 7;
            const alertThreshold = new Date(now.getFullYear(), now.getMonth(), now.getDate() + alertDays);
            
            let upcomingItems = [];

            installments.forEach(item => {
                const nextPaymentDate = getNextPaymentDate(item.firstPaymentMonth, item.paidPeriods);
                
                // åªæª¢æŸ¥æœªä¾†ä¸ƒå¤©å…§ä¸”æœªç¹³æ¸…çš„
                if (nextPaymentDate > now && nextPaymentDate <= alertThreshold && item.remainingPeriods > 0) {
                    upcomingItems.push(item);
                }
            });

            if (upcomingItems.length > 0) {
                const count = upcomingItems.length;
                const nextItem = upcomingItems[0];
                const nextPaymentMonth = formatMonth(getNextPaymentDate(nextItem.firstPaymentMonth, nextItem.paidPeriods));
                
                reminderMessage.innerHTML = `<span class="reminder-pulse relative inline-block mr-1 w-2 h-2 rounded-full bg-red-500"></span> <strong>${count} ç­†</strong>åˆ†æœŸå³å°‡åˆ°æœŸï¼æœ€è¿‘ä¸€ç­†æ˜¯ ${nextItem.item} çš„ ${nextPaymentMonth}ã€‚`;
                reminderContainer.classList.remove('hidden');
            } else {
                reminderContainer.classList.add('hidden');
            }
        }
        
        // --- æ­¸æª”åŠŸèƒ½ ---
        
        /**
         * å°‡å·²ç¹³æ¸…çš„åˆ†æœŸç§»å‹•åˆ°æ­¸æª”
         */
        function archiveItem(item) {
            const card = cards.find(c => c.id === item.cardId);
            item.cardName = card ? card.name : 'æœªçŸ¥å¡ç‰‡';
            item.archivedAt = Date.now();
            archive.unshift(item); 
            saveData(STORAGE_KEY_ARCHIVE, archive);
            console.log(`Archived item: ${item.item}`);
        }
        
        /**
         * æ¸²æŸ“æ­¸æª”åˆ—è¡¨
         */
        function displayArchive() {
            const list = document.getElementById('archiveList');
            list.innerHTML = '';
            document.getElementById('noArchive').classList.toggle('hidden', archive.length > 0);

            archive.forEach(item => {
                 const archiveDate = new Date(item.archivedAt).toLocaleDateString('zh-TW', { year: 'numeric', month: 'short', day: 'numeric' });
                 
                 list.innerHTML += `
                     <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 opacity-75">
                         <div class="flex justify-between items-start">
                             <h4 class="text-lg font-semibold truncate max-w-[70%]">${item.item}</h4>
                             <span class="text-sm font-medium px-2 py-1 rounded-full bg-gray-500 text-white">${item.cardName}</span>
                         </div>
                         <div class="mt-2 text-sm space-y-1 text-gray-600 dark:text-gray-400">
                             <p>ç¸½é‡‘é¡: ${formatCurrency(item.totalAmount)} / ç¸½æœŸæ•¸: ${item.totalPeriods}</p>
                             <p>å®Œæˆæ–¼: ${archiveDate}</p>
                         </div>
                     </div>
                 `;
            });
        }
        
        // --- å•Ÿå‹• ---
        window.onload = initializeApp;
        
    </script>
</body>
</html>
